import{b as i,r as L,l as ae,c,o as z,d as B,e as b,f as a,w as t,m as te,t as P,i as y,h as u,F as oe,n as ne,x as se,E as V,z as re,q as ie}from"./index-d2e98233.js";const ue={class:"role-manager"},de={class:"query-form"},ce={class:"base-table"},me={class:"action"},pe={class:"dialog-footer"},fe={class:"dialog-footer"},ge={__name:"Role",setup(_e){const K=i();let R={};const C=i(),N=i(),T=L([{label:"角色名称",prop:"roleName"},{label:"备注",prop:"remark"},{label:"权限列表",prop:"permissionList",width:400,formatter:(l,e,s)=>{let r=[];return(s.halfCheckedKeys||[]).map(d=>{let k=R[d];d&&k&&r.push(k)}),r.join(",")}},{label:"创建时间",prop:"createTime",formatter(l,e,s){return te.utc2beijing(s)}}]),w=L({roleName:""}),m=L({}),j={roleName:[{required:!0,message:"请输入角色名称"}]},v=i({total:0,pageNum:1,pageSize:10}),f=i(!1),g=i(!1),S=i(""),F=i(""),_=i("add"),h=i("添加"),M=i([]),$=i([]),A=l=>{F.value=l._id,S.value=l.roleName,g.value=!0;let{checkedKeys:e}=l.permissionList;setTimeout(()=>{N.value.setCheckedKeys(e)})},D=l=>{let e={};const s=r=>{for(;r.length;){let n=r.pop();n.children&&n.action&&(e[n._id]=n.menuName),n.children&&!n.action&&s(n.children)}};s(JSON.parse(JSON.stringify(l))),R=e},p=async()=>{const l={...P(w),...v.value};l.roleName||delete l.roleName;const{list:e,page:s}=await y.roleList(l);M.value=e,v.value=s},E=async()=>{const l=await y.menuList();$.value=l,D(l)};ae(()=>{p(),E()});const J=()=>{_.value="add",h.value="添加",f.value=!0},H=()=>{p()},O=l=>{f.value=!1,x(l)},I=async l=>{await y.updatePermission(l)},Q=()=>{let l=N.value.getCheckedNodes(),e=N.value.getHalfCheckedKeys(),s=[],r=[];l.map(d=>{d.children.length?r.push(d._id):s.push(d._id)});let n={_id:F.value,permissionList:{checkedKeys:s,halfCheckedKeys:r.concat(e)}};I(n),g.value=!1,V.success("设置成功"),p()},G=l=>{v.value.pageNum=l,p()};function W(l){l.validate(e=>{if(e){const s={...P(m)};s.action=_.value,y.roleOperate(s).then(r=>{V.success(h.value+"角色成功!"),f.value=!1,x(l),p()})}else V.error("校验表单失败")})}const x=l=>{l.resetFields()},X=l=>{_.value="edit",h.value=_.value==="add"?"增加":"编辑",f.value=!0,re(()=>{Object.assign(m,l)})};function Y(l){_.value="delete",h.value="删除";const e={_id:l,action:_.value};y.roleOperate(e).then(s=>{V.success("成功删除角色!"),p()})}return(l,e)=>{const s=c("el-input"),r=c("el-form-item"),n=c("el-button"),d=c("el-form"),k=c("el-table-column"),Z=c("el-table"),ee=c("el-pagination"),U=c("el-dialog"),le=c("el-tree");return z(),B("div",ue,[b("div",de,[a(d,{inline:"",model:w,ref_key:"formRef",ref:K},{default:t(()=>[a(r,{label:"角色名称",prop:"roleName"},{default:t(()=>[a(s,{modelValue:w.roleName,"onUpdate:modelValue":e[0]||(e[0]=o=>w.roleName=o),placeholder:"请输入角色名称"},null,8,["modelValue"])]),_:1}),a(r,null,{default:t(()=>[a(n,{type:"primary",onClick:H},{default:t(()=>[u("查询")]),_:1}),a(n,{onClick:e[1]||(e[1]=o=>{x(K.value),p()})},{default:t(()=>[u("重置")]),_:1})]),_:1})]),_:1},8,["model"])]),b("div",ce,[b("div",me,[a(n,{type:"primary",onClick:J},{default:t(()=>[u("创建角色")]),_:1})]),a(Z,{data:M.value},{default:t(()=>[(z(!0),B(oe,null,ne(T,o=>(z(),ie(k,{key:o.prop,prop:o.prop,label:o.label,width:o.width,formatter:o.formatter},null,8,["prop","label","width","formatter"]))),128)),a(k,{fixed:"right",label:"操作",width:"260"},{default:t(o=>[a(n,{onClick:q=>X(o.row),size:"small"},{default:t(()=>[u("编辑")]),_:2},1032,["onClick"]),a(n,{type:"primary",size:"small",onClick:q=>A(o.row)},{default:t(()=>[u("设置权限")]),_:2},1032,["onClick"]),a(n,{type:"danger",onClick:q=>Y(o.row._id),size:"small"},{default:t(()=>[u("删除")]),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"]),a(ee,{"hide-on-single-page":"",class:"pagination",small:"","page-size":v.value.pageSize,background:"",layout:"prev, pager, next",total:v.value.total||0,onCurrentChange:G},null,8,["page-size","total"])]),a(U,{title:h.value+"角色",modelValue:f.value,"onUpdate:modelValue":e[6]||(e[6]=o=>f.value=o),"before-close":()=>{O(C.value)}},{footer:t(()=>[b("span",pe,[a(n,{onClick:e[4]||(e[4]=o=>O(C.value))},{default:t(()=>[u("取消")]),_:1}),a(n,{type:"primary",onClick:e[5]||(e[5]=o=>W(C.value))},{default:t(()=>[u("确定")]),_:1})])]),default:t(()=>[a(d,{ref_key:"dialogForm",ref:C,model:m,"label-width":"100px",rules:j},{default:t(()=>[a(r,{label:"角色名称",prop:"roleName"},{default:t(()=>[a(s,{modelValue:m.roleName,"onUpdate:modelValue":e[2]||(e[2]=o=>m.roleName=o),placeholder:"请输入角色名称"},null,8,["modelValue"])]),_:1}),a(r,{label:"备注",prop:"remark"},{default:t(()=>[a(s,{type:"textarea",rows:2,modelValue:m.remark,"onUpdate:modelValue":e[3]||(e[3]=o=>m.remark=o),placeholder:"请输入备注"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["title","modelValue","before-close"]),a(U,{title:"权限设置",modelValue:g.value,"onUpdate:modelValue":e[8]||(e[8]=o=>g.value=o)},{footer:t(()=>[b("span",fe,[a(n,{onClick:e[7]||(e[7]=o=>g.value=!1)},{default:t(()=>[u("取 消")]),_:1}),a(n,{type:"primary",onClick:Q},{default:t(()=>[u("确 定")]),_:1})])]),default:t(()=>[a(d,{"label-width":"100px"},{default:t(()=>[a(r,{label:"角色名称"},{default:t(()=>[u(se(S.value),1)]),_:1}),a(r,{label:"选择权限"},{default:t(()=>[a(le,{ref_key:"tree",ref:N,data:$.value,"show-checkbox":"","node-key":"_id","default-expand-all":"",props:{label:"menuName"}},null,8,["data"])]),_:1})]),_:1})]),_:1},8,["modelValue"])])}}};export{ge as default};
